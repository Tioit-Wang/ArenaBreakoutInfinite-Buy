当点击任务开始的时候，会自动执行以下步骤（统一使用“模版/按钮/标识”的术语）：

1. 检查游戏是否已启动（统一启动流程）
   - 判定条件：屏幕上任意匹配到【首页标识模版】或【市场标识模版】即视为“已启动”。
   - 若未启动，则执行“启动游戏”流程：
     1) 校验是否已配置【游戏启动器路径】；未配置或路径不存在则报错，**任务停止**。
     2) 执行启动器；
     3) 监听【启动按钮模版】是否出现（超时时间由配置项 `launcher_timeout_sec` 控制）；出现后按配置的点击延时 `launch_click_delay_sec` 等待并点击；
     4) 点击后等待【首页标识模版】或【市场标识模版】出现（超时时间 `startup_timeout_sec`，默认 180 秒）；若超时未出现，判定启动失败，**任务停止**。
   - 正常完成以上步骤后，判定为“游戏已启动”。

2. 读取任务列表并校验
   - 排序：按任务的 `order` 升序排列。
   - 校验：每个任务需满足以下条件，否则判定为无效并跳过：
     - 存在 `item_id` 且可在 `goods.json` 中找到对应条目；
     - 对应条目的 `search_name` 非空；
     - 对应条目的【商品图片模版（goods.image_path）】文件存在。

3. 选择执行模式
   - 轮询模式：按顺序对启用且有效、未达目标的任务，逐个执行“片段”（片段时长为配置的分钟数）。
   - 时间窗口模式：在所有启用且有效的任务中，选择当前时间命中其【开始时间~结束时间】窗口的第一个任务执行，直至窗口不再命中。
   - 均支持“周期性软重启”与“暂停/继续/终止”。

4. 进入购买流程（分为两个模块）

   【模块一：进入搜索结果页面】

   - 可能遇到的“阻碍性”事件（需优先处理）：
     1) 商品详情未关闭（同时存在【关闭按钮模版】与【购买按钮模版】）→ 点击【关闭按钮模版】关闭详情；
     2) 停留在“购买成功”弹出界面（存在【购买成功标识模版】）→ 任意点击一下，再点击【关闭按钮模版】关闭详情。

   - 确认无阻碍后，判断当前页面类型：
     - 若匹配到【首页标识模版】（在首页）：
       1) 点击【市场按钮模版】；
       2) 点击【搜索框模版】；
       3) 输入“搜索内容”（使用 `goods.search_name`）；
       4) 点击【搜索按钮模版】；
       5) 匹配到【商品图片模版】后，缓存其坐标为“临时坐标缓存”，后续点击商品优先使用该坐标（不再重复匹配）。
     - 若匹配到【市场标识模板】（在市场页，此时代表搜索状态不明，需要重置）
       1) 点击【首页按钮模版】；
       2) 点击【市场按钮模版】；
       3) 点击【搜索框模版】；
       4) 输入“搜索内容”（使用 `goods.search_name`）；
       5) 点击【搜索按钮模版】；
       6) 匹配到【商品图片模版】后，缓存其坐标为“临时坐标缓存”，后续点击商品优先使用该坐标（不再重复匹配）。

     以上步骤完成，视为“进入搜索结果页面成功”，并成功获取“商品图片坐标缓存”。

   【模块二：购买循环】

   - 初次进入详情页（本***任务**的第一次，）：
     - 立即匹配并缓存【关闭按钮模版】与【购买按钮模版】的坐标；若商品为“弹药”类型，还需缓存【Max按钮模版】的坐标；后续点击均优先使用坐标（不再重复匹配）。

   - 通用循环流程：
     1) 点击商品（使用“临时坐标缓存”）进入商品详情页；
     2) 截取并识别价格（复用初始化配置中的平均价格识别模块的逻辑）：
        - 以【购买按钮模版】为锚点推导“平均单价 ROI”，截屏并二值化；
        - OCR 引擎：默认 Umi（以配置中配置的 OCR 引擎为准）；失败/无法解析则关闭详情并结束本轮；
        - Umi 致命错误则终止任务；
     3) 判断是否满足“补货模式”条件：
        - 满足：
          - 点击【最大按钮模版】（若为弹药）；
          - 点击【购买按钮模版】；
          - 识别购买结果：
            - 成功：更新购买数量；将鼠标移至安全区并任意点击以关闭“成功遮罩”（价格会自动刷新）；继续识别并重复购买，直至价格不合适，再点击【关闭按钮模版】；
            - 失败：点击【关闭按钮模版】；
        - 不满足：进入“普通购买模式”判断：
          - 满足：点击【购买按钮模版】→ 成功则按分类更新数量并关闭成功遮罩→ 重复购买，直至价格不合适，再点击【关闭按钮模版】；失败则点击【关闭按钮模版】；
          - 不满足：点击【关闭按钮模版】；
     4) 暂停约 50ms，重复步骤 1–4，直到达到结束条件（如目标数量、时间片段结束或时间窗口退出等）。

5. 定时重启（周期逻辑）
   - 触发条件：累计运行时间大于配置的“重启周期”即触发重启，并重置累计运行时间。
   - 触发时机：每轮“购买循环”开始前检查；若任务为“顺序执行”类型，检查前先暂停片段计时。
   - 重启步骤：
     1) 点击【首页按钮模版】；等待约 5 秒；
     2) 点击【设置按钮模版】；等待约 5 秒；
     3) 点击【退出游戏按钮模版】；等待约 5 秒；
     4) 点击【退出确认按钮模版】；等待约 30 秒；
     5) 执行“统一启动流程”（参考第 1 步的启动流程）；若超时或失败，判定启动失败，任务停止；
     6) 执行“购买流程-进入搜索结果页面”（参考第 4 步【模块一】），重建搜索上下文；
     7) 重新开始“购买循环”，恢复“顺序执行任务”的计时，并重置累计运行时间。

6. 日志等级（过滤显示）
   - 等级：`debug` / `info` / `error`；在界面可选择显示等级，并同步到任务运行器以减少无关日志。
   - 未携带等级的旧文案由运行器自动补标签（启发式：失败/错误/超时→error；耗时/匹配→debug；其他→info）。

7. 缓存与加速
   - 商品坐标缓存：进入详情后缓存列表项位置，后续可优先点击并快速验证。
   - 详情按钮缓存：进入详情后缓存【购买/关闭/最大】按钮的模版匹配结果，加速后续步骤。

8. 常见失败与恢复
   - 打开详情失败：
     - 缓存坐标无效：本轮结束；
     - 模版匹配失败：尝试一次“恢复性搜索”后再匹配；仍失败本轮结束。
   - 读取价格失败：
     - ROI 计算/截屏/解析失败：关闭详情结束本轮；
     - Umi 致命错误：抛出异常，**任务停止**。

9. 终止与软重启
   - 终止：收到“终止”信号后尽快结束当前片段/窗口循环。
   - 软重启：按周期尝试回到登录/首页/市场，重建搜索上下文，不计入片段时长。
