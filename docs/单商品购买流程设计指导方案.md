# 单商品购买流程设计指导方案

本文件为强制性指导方案，所有实现与联调必须严格遵循；任何偏离需在评审中提出并获批准。

适用范围：单商品自动购买；以模板匹配与 OCR 为核心。本方案定义“调度模式、重启策略、会话边界、日志与历史记录”等运行时行为，并对购买步骤顺序做统一规范。

## 全局标准化要素

- 关键界面：启动器首页、游戏首页、市场页、商品列表页、商品详情页、购买成功弹层
- 关键模板：
  - 入口/导航：`btn_launch`、`home_indicator`、`market_indicator`、`btn_home`、`btn_market`
  - 搜索：`input_search`、`btn_search`、商品图片模板（来自商品配置的图片路径）
  - 详情/购买：`btn_buy`、`btn_close`、`btn_max`（可选）、`qty_minus`、`qty_plus`、`buy_ok`、`buy_fail`
  - 处罚提示：`penalty_warning`、`btn_penalty_confirm`
- OCR/ROI（均价）：以 `btn_buy` 为锚点，向上 `avg_price_area.distance_from_buy_top` 的矩形，高度 `avg_price_area.height`，可按 `avg_price_area.scale` 缩放；仅识别数字。明确“不使用下半区兜底”。
- OCR/ROI 算法实现（强制）：
  - 锚点定位顺序：优先使用“本会话按钮缓存”→ 在上次按钮框周边（向四周扩 8–80px 的小区域）做快速重定位 → 全局模板匹配；记录命中来源用于排障。
  - ROI 计算：
    - 输入：购买按钮矩形 `(b_left,b_top,b_w,b_h)`；参数 `distance_from_buy_top`（默认 5）、`height`（默认 45）、`scale∈[0.6,2.5]`；
    - 特判：若商品支持兑换，`distance_from_buy_top += 30`；
    - 公式：`y_bottom = b_top - distance_from_buy_top`；`y_top = y_bottom - height`；`x_left = b_left`；`width = max(1, b_w)`；将 `(x_left,y_top,width,height)` 裁剪到屏幕范围内；
  - 分割与缩放：将 ROI 一分为二（上半=平均价、下半=合计），按 `scale` 重采样，限制范围 [0.6, 2.5]；（实现上仅使用上半区进行均价识别）
  - 二值化：优先 Otsu（OpenCV）阈值化，异常时回退到灰度+固定阈值（PIL）；
  - 识别策略：
    - 仅对上半区域（平均单价）进行识别：先数字识别，失败再文本识别并本地解析为数字；
    - 不对下半区域进行兜底识别；
  - 异常值过滤：若提供 `expected_floor>0` 且识别值小于 `expected_floor/2`，判为异常丢弃并累计 OCR 失败计数；
  - 产物与调试：可选启用调试叠加；可选保存 ROI 原图/上下半图/二值图到 `output/debug/roi/`；识别成功写入价格历史；
  - 时序：OCR 请求默认超时 2.5s；步骤微延时遵循“运行步进”。
- 默认时序（微延时）：
  - 详情进入后不叠加固定等待；依靠“识别轮（窗口+步进）”自然收敛到可识别状态；
  - 购买结果识别窗口 0.8s，20ms 轮询步进（可按参数放大）；
  - 启动与重启涉及的长等待按启动器/设置页既定策略执行。
- 成功弹层关闭：优先“当前位置快速单击”关闭遮罩；若未缓存可见坐标，则采用“光标移至右上角 → 中间单击 → 回右上角”的保守路径，降低大跨度移动与遮挡风险。

## 界面说明与模板分布（强制）

- 启动器首页：
  - 模板：`btn_launch`
  - 用途：启动游戏客户端。
- 游戏首页：
  - 模板：`home_indicator`、`btn_market`、`btn_settings`、`btn_home`
  - 用途：作为返回和导航基准，进入市场页、进入设置。
- 市场页（含搜索区与列表区）：
  - 模板：`market_indicator`、`input_search`、`btn_search`、商品图片模板（卡片）
  - 用途：执行关键词搜索并定位商品卡片。
- 商品列表页（市场内）：
  - 模板：商品图片模板（卡片宫格/列表）
  - 用途：点击卡片进入详情。
- 商品详情页：
  - 模板：`btn_buy`、`btn_close`、（可选）`btn_max`、`qty_minus`、`qty_plus`
  - 用途：读取均价、购买、调节数量、关闭返回列表。
- 购买结果弹层：
  - 模板：`buy_ok`、`buy_fail`
  - 用途：购买结果识别与后续动作（关闭遮罩/关闭详情）。
- 处罚提示弹层：
  - 模板：`penalty_warning`、`btn_penalty_confirm`
  - 用途：OCR 连续失败后的人机验证处理。
- 设置/退出相关：
  - 模板：`btn_settings`、`btn_exit`、`btn_exit_confirm`
  - 用途：软重启流程。

## 调度模式与会话边界

本方案由调度器驱动，支持两种模式：

- 轮询片段模式（`task_mode=round`）

  - 任务按 `order` 升序轮询，跳过未启用/无效/已达目标任务。
  - 每个任务进入“片段会话”，持续 `duration_min` 分钟：
    1. 片段开始时建立搜索上下文（步骤 4）；
    2. 独立执行一次“预缓存（预热）”（步骤 5）；
    3. 在片段内循环执行“购买尝试”（步骤 6–7），直至片段结束或任务达到目标。
  - 软重启会暂停片段计时；重启后需清空缓存、重建搜索上下文并重新执行“预缓存”。

- 时间窗口模式（`task_mode=time`，默认）
  - 在所有已启用且有效的任务中，选择“当前本地时间命中 `[time_start, time_end]` 窗口”的第一个任务进入会话；若无命中则 1.2 秒节奏轮询等待。
  - 进入窗口时建立搜索上下文（步骤 4），随后独立执行一次“预缓存（预热）”（步骤 5），再循环执行“购买尝试”（步骤 6–7）；当窗口不再命中、暂停或停止时退出会话。
  - 重启后需清空缓存并重新建立搜索上下文与“预缓存”。

统一控制：

- 开始/暂停/继续/停止：均为全局控制；暂停期间每 200ms 轮询恢复。
- 目标达成：`target_total>0` 且累计 `purchased>=target_total` 时结束当前任务会话。
- 日志前缀规范：`【时间】【物品显示名】【已购/目标】`，全局事件以 `【全局】` 标记。

## 步骤与顺序

本方案将“调度/会话边界”纳入整体流程，步骤按如下顺序执行：

### 步骤 1：全局启动与准备

- 目标：确保已进入可识别的首页或市场场景。
- 涉及界面：启动器首页、游戏首页、市场页
- 图片模板：`btn_launch`、`home_indicator`、`market_indicator`
- 特殊固定参数：
  - 启动按钮轮询上限：≤60s；点击启动按钮前固定等待：15s；首页/市场标识轮询上限：≤180s；
- OCR 相关：无
- 延时与超时：

  - 模板轮询步进 20–50ms；
  - 界面打开/关闭后的强制等待：100ms（确保内容完成加载/退出）；
  - 注：购买成功的识别与等待遵循其专用窗口，不受此条约束。

- 操作：调用启动流程，若已在游戏内则跳过启动；否则按按钮模板点击启动并等待首页/市场标识。
- 成功条件：命中 `home_indicator` 或 `market_indicator`。
- 失败处理：超时未命中则记录失败并终止。

### 步骤 2：任务选择与会话进入（调度）

- 涉及界面：调度层（无画面要求）
- 图片模板：无
- 特殊固定参数：
  - 轮询片段模式：`duration_min`（分钟）；
  - 时间窗口模式：`time_start`/`time_end`（`HH:MM`，支持跨日）；
- OCR 相关：无
- 延时与超时：

  - 任务列表为空：0.6s 节奏；
  - 未命中时间窗口：1.2s 节奏；
  - 暂停轮询：200ms。

- 轮询片段模式：按顺序选择“启用且有效且未达目标”的任务 → 进入“片段会话（duration_min 分钟）”。
- 时间窗口模式：选择“当前时间命中窗口”的任务 → 进入“窗口会话（直到窗口结束）”。
- 进入任一会话后，执行步骤 3–8；其中步骤 5 为独立预热，不进入循环；会话结束时记录统计并回到模式选择。

### 步骤 3：障碍清理与初始化检查（轻量）

- 目标：保证回到列表层级或稳定的首页/市场状态。
- 涉及界面：列表/详情、购买成功弹层
- 图片模板：`btn_buy`、`btn_close`、`buy_ok`
- 特殊固定参数：无
- OCR 相关：无
- 延时与超时：

  - 关闭详情后：强制等待 100ms；
  - 购买成功遮罩：“当前位置快速单击”后按既定等待（≥300ms），不额外叠加 100ms；

- 操作：
  - 若同时命中 `btn_buy` 与 `btn_close` → 点击 `btn_close` 关闭遗留详情；
  - 若命中 `buy_ok` → 快速单击关闭购买成功遮罩 → 再尝试 `btn_close`；
  - 根据 `home_indicator`/`market_indicator` 判断当前场景，必要时 `btn_home` 回首页、`btn_market` 进市场。
- 成功条件：稳定处于首页或市场（可进入搜索）。
- 失败处理：关键模板缺失则记录失败并结束本轮会话。

### 步骤 4：搜索与列表定位（建立搜索上下文）

- 目标：通过关键词定位商品卡片并缓存列表坐标。
- 涉及界面：市场页（含搜索区/列表区）、游戏首页（回跳重置）
- 图片模板：`btn_market`、`btn_home`、`input_search`、`btn_search`、商品图片模板
- 特殊固定参数：无
- OCR 相关：无
- 延时与超时：

  - 点击 `btn_market`/`btn_home` 导航产生界面切换后：强制等待 100ms；
  - 点击输入框后 ≈30ms、输入完成 ≈30ms、点击搜索后渲染等待 20–50ms；
  - 商品模板匹配总超时：≤2.5s；

- 输入：目标检索词（商品名称/别名）；商品模板（来自商品配置的图片路径）。
- 操作：
  - 在首页：点击 `btn_market` → 定位 `input_search` → 输入检索词 → 点击 `btn_search`；
  - 在市场：必要时先 `btn_home` 回首页再 `btn_market` 重置 → 执行上述输入与搜索；
  - 使用商品图片模板匹配卡片并缓存矩形到临时坐标缓存。
- 成功条件：完成卡片定位与坐标缓存。
- 失败处理：任一元素未匹配 → 记录失败并结束本轮会话/片段；可在下次调度重试。

### 步骤 5：预缓存（预热，独立一次）

- 目标：在进入循环前，独立执行一次“进入详情 → 识别与缓存关键元素 → 轻量 OCR 验证 → 退出详情”，确保后续循环稳定执行。
- 涉及界面：商品列表页 → 商品详情页
- 图片模板：商品图片模板、`btn_buy`、`btn_close`、（可选）`btn_max`、`qty_minus`、`qty_plus`
- 特殊固定参数：
  - 每个关键步骤后固定等待 2s（仅本预热流程）；
  - 预热必须建立关键按钮缓存与数量输入锚点；
- OCR 相关：
  - 轻量 OCR 验证使用“OCR 识别轮”（窗口 0.5s、步进 20ms），仅识别上半区“平均单价”，不使用下半兜底；
  - 识别失败计入 OCR 连败并可能触发处罚；
- 延时与超时：
  - 打开详情后不叠加固定等待；通过模板验证 `btn_buy` 与 `btn_close`（单次匹配超时 ≈0.3–0.4s）。

- 操作：
  1. 优先使用列表坐标缓存打开详情（失败回退商品模板匹配）；
  2. 验证并缓存 `btn_buy`、`btn_close`，弹药类额外缓存 `btn_max`；
  3. 计算并缓存数量输入锚点（`qty_minus` 与 `qty_plus` 的几何中点）供后续快速输入；
  4. 以“OCR 识别轮”对上半区 ROI 做一次轻量验证（不写历史，验证链路即可）；
  5. 关闭详情返回列表。
- 成功条件：关键按钮与数量输入锚点完成缓存；OCR 验证不强制成功但会参与处罚统计。
- 失败处理：任一步失败即执行障碍清理并判定预缓存失败；按“重试策略”执行。

#### 预缓存重试策略（统一）

- 最多重试 3 次；两次尝试之间指数退避：1s → 2s → 4s；
- 仍失败：
  - 轮询片段模式：跳过本片段任务；
  - 时间窗口模式：终止该任务在本窗口内的执行。

### 步骤 6：价格读取与阈值判定（循环头）

- 目标：读取“平均单价”并判定是否进入普通或补货购买。
- 涉及界面：商品详情页（均价上方区域）
- 图片模板：`btn_buy`（锚点）、`btn_close`
- 特殊固定参数：`distance_from_buy_top=5`（兑换加 30）、`height=45`、`scale∈[0.6,2.5]`、异常值过滤 `expected_floor/2`；
- OCR 相关：以 `btn_buy` 为锚点计算 ROI，必要时在“缓存附近小区域”先重定位再计算；仅识别上半区“平均单价”（数字优先，失败再文本解析），不使用下半区兜底；OCR 请求默认超时 2.5s；
- 延时与超时：锚点定位短超时 ≈0.3s；OCR 超时按前述；
- 判定：
  - 普通价：`unit_price ≤ price_threshold × (1 + price_premium_pct%)`
  - 补货价：`unit_price ≤ restock_price × (1 + restock_premium_pct%)`
  - 均不满足：关闭详情返回列表，继续下一轮尝试
- 合理性下限：`expected_floor = max(price_threshold, restock_price)`（存在时）；OCR 明显偏低/异常则视为失败累加计数。

### 步骤 7：执行购买（普通 / 补货）

- 涉及界面：商品详情页、购买结果弹层
- 图片模板：`btn_buy`、`buy_ok`、`buy_fail`、`btn_close`、（补货）`btn_max`、`qty_minus`、`qty_plus`
- 特殊固定参数：
  - 结果识别窗口：0.8s（20ms 轮询步进，可调）；
  - 非弹药补货数量：固定 5（定位失败退化为 1）；弹药补货：首次点击 `btn_max`；
  - 普通模式增量（进度统计）：弹药 +10、非弹药 +1；补货模式增量：按 Max/数量设置计算；
- OCR 相关：仅用于价格判定；
- 延时与超时：

  - 购买结果识别窗口：0.8s（20ms 轮询步进，可调）；
  - 购买成功后“遮罩关闭点击”按既定等待（≥300ms），不额外叠加 100ms；
  - 购买失败/未知后“关闭详情”：强制等待 100ms；

- 普通购买：

  - 点击 `btn_buy`；在 0.8s 窗口内轮询 `buy_ok`/`buy_fail`；
  - 成功：记录购买历史（含任务/物品/价格/数量），快速单击关闭遮罩，继续循环；
  - 失败或未知：关闭详情，结束本轮。

- 补货购买（快速循环）：
  - 弹药：仅首次点击 `btn_max`；
  - 非弹药：仅首次以 `qty_minus` 与 `qty_plus` 的几何中点定位输入框，输入固定数量 5（定位失败退化为 1）；
  - 循环体：读均价 → 满足补货上限则点击购买 → 成功后快速关闭遮罩并累加数量 → 达目标或价格不再满足时关闭详情退出。

### 步骤 8：会话内循环与退出条件（调度衔接）

- 轮询片段模式：在片段时间内循环步骤 6–7；重启后需重建搜索上下文与“预缓存”；片段结束统计 `executed_ms` 并退出。
- 时间窗口模式：在窗口命中期间循环步骤 6–7；窗口失配或目标达成即退出。
- 涉及界面：详情/列表/处罚提示弹层/全局
- 图片模板：`penalty_warning`、`btn_penalty_confirm`
- 特殊固定参数：
  - OCR 连续失败阈值（建议默认 10）；处罚确认延迟 5s；处罚等待 180s；
  - 软重启按周期触发，重启后必须重建搜索上下文；
- OCR 相关：统计失败次数，不额外发起 OCR；
- 延时与超时：

  - 会话循环微等待：20ms；暂停轮询：200ms；未命中窗口：1.2s；任务空列表：0.6s；

- 持续无法识别与处罚：
  - 统计 OCR 连续失败次数；达到阈值时检查处罚提示，在“处罚确认延迟”后点击确认按钮，再等待“处罚等待时长”恢复；
  - 处罚链路结束后清零计数并继续尝试。

## 持续无法识别回跳策略（统一）

- 触发条件（建议默认）：
  - OCR 连续失败达到阈值（如 10 次，见 `multi_snipe_tuning.ocr_miss_penalty_threshold`）；
  - 模板在同一环节持续未命中达到阈值（实现可配置，自行统计）；
  - 购买结果“未知/超时”在短时间出现多次。
- 处理流程：
  1. 先执行处罚检测与处理（见步骤 8）；
  2. 若仍无法推进，则在当前会话内结束本轮，等待下次调度进入；
  3. 进入下次会话时按步骤 3–4 重建上下文。

## 软重启流程（调度内置）

- 触发：`restart_every_min>0` 且到达周期。
- 操作：`btn_home` → 等 5s → `btn_settings` → 等 5s → `btn_exit` → `btn_exit_confirm` → 等待配置冷却 → 重新执行启动（步骤 1）。
- 片段模式下暂停会话计时；重启后必须重新建立搜索上下文再继续。

## 配置要点与数据约束

- 任务配置：
  - 公共：任务标识、物品标识、显示名称、启用状态、目标数量、价格阈值与溢价（普通/补货）。
  - 轮询片段模式：片段时长（分钟）。
  - 时间窗口模式：开始时间、结束时间（格式 `HH:MM`，支持跨日）。
- 物品配置：
  - 必填：物品标识、搜索名称、图片路径；可选：物品名称、大类（“弹药”触发 `Max` 逻辑）。
- OCR 区域：
  - 以购买按钮为锚点的垂直偏移与高度、可选缩放比例。
- 调试参数：
  - 可选覆盖层/图像保存、步进延时、保存目录等。
- 运行步进：
  - 默认 15ms；调试启用时放大至不低于 20ms 且不高于 200ms。
- 处罚与结果窗口：
  - OCR 失败阈值、处罚确认延迟、处罚等待时长、购买结果识别窗口时长。

## 关键要求与约束

- 明确“调度模式 + 会话边界”，严格按步骤 2/8 管理上下文建立与循环范围。
- 成功弹层关闭采用“当前位置快速单击 + 兜底保守移动”，不得回退为大幅移动或固定安全区点击（除非评审批准）。
- 购买结果识别窗口为可配置参数（默认 0.8s）；调试模式应适度放大以降低漏检风险。
- 软重启为内置能力，应与片段计时/窗口循环解耦，并在重启后重建上下文。
- 任务切换或软重启后，必须清空与该商品相关的全部缓存（列表坐标、首次按钮缓存、会话 UI 缓存），并在进入循环前重新执行“步骤 5：预缓存（预热）”。

## 附：日志与历史

- 日志：统一日志接口输出，自动加等级标签并按日志等级过滤。
- 历史：
  - 价格：均价识别成功后写入价格历史（含时间戳与 ROI 调试样本，可选保存）。
  - 购买：成功后写入购买历史（物品/任务/单价/数量/是否使用 Max）。

—— 以上为本文件的强制性指导规范。实现侧需确保：

- 任何进入详情/购买的点击优先使用缓存坐标，失败再回退模板匹配；
- “进入会话 → 建立搜索上下文 → 循环尝试购买 → 会话退出”的边界严格遵循所选调度模式；
- 处罚检测与软重启对会话的影响符合本文描述。
