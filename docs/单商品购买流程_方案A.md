# 单商品购买模式-购买流程说明（方案 A）

仅描述“单商品购买”的购买相关环节；配置读取与调度不在范围内。实现以模板匹配与 OCR 为基础。本文件为唯一标准。

## 标准化要素清单（全局）

- 关键界面：启动器首页、游戏首页、市场页、商品列表页、商品详情页、购买成功弹窗
- 关键模板：`home_indicator`、`market_indicator`、`btn_home`、`btn_market`、`input_search`、`btn_search`、商品图片模板、`btn_buy`、`btn_close`、`btn_max`、`qty_minus`、`qty_plus`、`buy_ok`、`buy_fail`、`penalty_warning`、`btn_penalty_confirm`
- OCR/ROI：以 `btn_buy` 为锚点，上方 `distance_from_buy_top` 高度为 `height` 的矩形，按 `scale` 可选缩放（仅使用“平均价格”区域，不启用合计区兜底）
- 默认时序（强约束）：详情固定等待 50ms；购买结果识别窗口固定 0.8s（窗口内循环轮询，步进 20ms）；渲染稳定等待 20–50ms
- 安全区域：以 `btn_close` 的垂直中线为基准，向左水平偏移 100px 的位置（越界时就近裁剪）

## 步骤 1：启动游戏

- 目标：从桌面启动并进入游戏首页
- 输入：启动器绝对路径；`启动游戏按钮` 模板；`游戏首页-首页标识` 模板
- 操作：
  - 启动启动器 → 1 分钟内轮询 `启动游戏按钮`
  - 命中后原地等待 15 秒 → 点击 `启动游戏按钮`
  - 3 分钟内轮询 `游戏首页-首页标识`
- 成功条件：命中首页标识
- 超时/失败：未命中则终止流程并返回失败
- 附加（异常清理）：若出现模板长时间未命中/异常状态，执行“处罚提示检测与清理”后再判定

## 步骤 2：初始化检查

- 目标：识别当前位置并回到首页，清理意外状态
- 入口条件：游戏已启动
- 回跳入口：任一流程触发“持续无法识别/连续失败”时，应回到本步骤执行状态清理
- 关键模板：`home_indicator`、`market_indicator`、`btn_home`、`btn_market`、`btn_buy`、`btn_close`、`buy_ok`
- 操作：
  - 若同时命中 `btn_buy` 与 `btn_close` → 点击 `btn_close`
  - 若命中 `buy_ok` → 点击安全区域关闭 → 再次尝试 `btn_close`
  - 若不在首页 → 点击 `btn_home` 回首页；必要时点击 `btn_market` 进入市场
- 成功条件：回到首页或市场的稳定状态
- 失败处理：任一步骤模板缺失时记录失败并中止本轮
- 附加（异常清理）：模板持续未命中/异常抖动时，执行“处罚提示检测与清理”后再判定
- 状态清理内容：
  - 关闭购买成功弹窗（点击安全区域）与遗留详情（点击 `btn_close`）
  - 返回首页（`btn_home`）并重新进入市场（`btn_market`），以重置页面状态
  - 可选：刷新本地临时坐标缓存（避免沿用失效坐标导致误点）

## 步骤 3：搜索流程

- 目标：通过关键词检索定位商品列表
- 输入：目标检索词（商品名称/别名）
- 关键模板：`input_search`、`btn_search`
- 操作：
  - 点击 `input_search` 获取焦点 → 清空并输入检索词
  - 点击 `btn_search` 触发搜索 → 等待渲染 20–50ms
- 成功条件：进入可供模板匹配的商品列表
- 失败处理：任一元素未匹配 → 记录失败并中止本轮
- 附加（异常清理）：模板持续未命中时，执行“处罚提示检测与清理”；若仍失败 → 回跳至“步骤 2：初始化检查”

## 步骤 4：坐标缓存流程

- 目标：命中商品卡片并建立详情/价格识别所需的坐标缓存
- 关键模板：商品图片模板、`btn_buy`、`btn_close`、`btn_max`、`qty_minus`、`qty_plus`
- 操作：
  - 商品卡片定位与缓存：模板匹配卡片 → 缓存卡片矩形
  - 进入详情与按钮缓存：点击卡片 → 等待 50ms → 缓存 `btn_buy`、`btn_close`；若存在 `btn_max` 一并缓存
  - 绑定平均价 ROI：以 `btn_buy` 为锚点计算 ROI（`distance_from_buy_top`、`height`、`scale`）并缓存
  - 数量输入定位（仅在无 Max 时）：以 `qty_minus` 与 `qty_plus` 中点作为数量输入中心并缓存
- 缓存项：卡片矩形、`btn_buy`、`btn_close`、`btn_max`（可选）、平均价 ROI、数量输入中心（可选）
- 成功条件：完成以上缓存任一必需项（卡片、`btn_buy`、ROI）
- 失败处理：任一必需项未命中 → 记录失败并中止本轮
- 附加（异常清理）：模板持续未命中或 ROI 计算异常时，执行“处罚提示检测与清理”；若仍失败 → 回跳至“步骤 2：初始化检查”

## 步骤 5：购买循环（普通 / 补货）

- 目标：在价格合规前提下执行购买，直至退出条件成立
- 前置：已完成步骤 4 的缓存
- 判定：使用缓存的平均价 ROI 进行价格识别 → 决策进入“补货”或“普通”逻辑；均不满足则退出

  5.1 进入详情与价格判定（循环头）

- 操作：点击商品卡片 → 等待 50ms；使用“平均价格”ROI 进行数字 OCR 识别（仅数字，无文本兜底；识别失败则退出）
- 判定：
  - 满足补货价（`restock_price` ± `restock_premium_pct`）→ 进入 5.3 补货逻辑
  - 满足普通价（`price_threshold` ± `price_premium_pct`）→ 进入 5.2 普通逻辑
  - 均不满足 → 点击 `btn_close` 退出循环
- 附加（异常清理）：价格 OCR 连续失败时，执行“处罚提示检测与清理”；若仍失败 → 回跳至“步骤 2：初始化检查”

  5.2 普通购买逻辑

- 关键模板：`btn_buy`、`buy_ok`、`buy_fail`、`btn_close`
- 操作：点击 `btn_buy`
- 等待/超时：在 0.8s 内循环轮询 `buy_ok`/`buy_fail`，每次轮询之间暂停 20ms
- 成功条件：命中 `buy_ok` → 点击“安全区域”（`btn_close` 左侧 100px、同垂直中线）关闭成功弹窗 → 点击 `btn_close` 返回 → 标记成功
- 失败处理：命中 `buy_fail` 或超时 → 点击 `btn_close` 返回 → 标记失败
- 附加（异常清理）：在结果识别过程中若模板持续未命中，执行“处罚提示检测与清理”；若仍失败 → 回跳至“步骤 2：初始化检查”

  5.3 补货购买逻辑

- 关键模板：`btn_max`（可选）、数量输入中心（来自缓存）、`btn_buy`、`buy_ok`、`buy_fail`、`btn_close`
- 操作：
  - 设置数量：
    - 若支持 `btn_max` → 点击一次
    - 否则 → 点击数量输入中心 → 输入 "5"（固定，不可配置）
  - 执行购买：点击 `btn_buy`
- 等待/超时：在 0.8s 内循环轮询 `buy_ok`/`buy_fail`，每次轮询之间暂停 20ms
- 成功条件：命中 `buy_ok` → 点击“安全区域”（`btn_close` 左侧 100px、同垂直中线）关闭成功弹窗 → 复检价格
  - 若仍满足补货阈值 → 回到“设置数量”继续循环
  - 若不再满足 → 点击 `btn_close` 退出补货逻辑
- 失败处理：命中 `buy_fail` 或超时 → 点击 `btn_close` 返回 → 标记失败
- 附加（异常清理）：在设置数量/结果识别/复检价格任一环节，模板或 OCR 持续未命中时，执行“处罚提示检测与清理”；若仍失败 → 回跳至“步骤 2：初始化检查”

## 持续无法识别回跳策略（统一）

- 触发条件（建议）：
  - OCR 连续失败达到实现定义的阈值（推荐默认 3 次）
  - 模板匹配在同一环节持续超时/未命中达到阈值（推荐默认 3 次）
  - 购买结果“未知/超时”在短时间内出现多次（推荐默认 2 次）
- 处理流程：
  1. 先执行“处罚提示检测与清理”；
  2. 若仍无法推进 → 回跳至“步骤 2：初始化检查”执行状态清理；
  3. 重新进入后续流程（从步骤 3 开始）。

## 关键特性

- 双层缓存：首次缓存 + 会话缓存；界面微重排时优先小范围重定位
- OCR：仅数字识别；不启用文本兜底；不启用“合计区兜底”；仅使用“平均价格”ROI
- 成功弹窗关闭：点击“安全区域”（`btn_close` 左侧 100px、同垂直中线），减少大跨度移动干扰识别
- 补货一次化：`Max`/数量只在进入补货会话时设置一次；每次成功后立即复检价格；无 `btn_max` 时数量固定 5
- 购买结果识别：固定最长 0.8s 窗口，20ms 轮询步进

## 处罚提示检测与清理（统一）

- 触发时机：任一流程/子步骤出现模板长时间未命中、OCR 连续失败或价格判定无法推进时
- 检测与处理：
  - 检测 `penalty_warning` 模板；存在则在确认延迟 5s 后点击 `btn_penalty_confirm`
  - 点击后等待 180s，再清零本地“连续失败”计数并恢复流程
- 参数（固定）：确认延迟 5s；等待 180s
